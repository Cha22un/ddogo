<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin">

    <select id="getUserTotal" resultType="int">
        <![CDATA[
        select count(user_no)
        from user
      ]]>
    </select>

    <select id="getRecentUser" resultType="int">
        <![CDATA[
        select count(user_no)
        from user
        where timestampdiff(month,join_date,now())<1
      ]]>
    </select>

    <select id="hotplaceRank" resultType="com.yumpro.ddogo.admin.domain.RankingDTO">
        <![CDATA[
        SELECT
            MAX(hp.hotplace_no) AS hotplace_no,
            hp.sido,
            hp.gugun,
            hp.hotplace_name,
            hc.hotplace_cate_name,
            SUM(CASE WHEN mm.recom = 'Y' THEN 1 ELSE 0 END) AS recom_count,
            AVG(COALESCE(er.emo_result, 0)) AS emo_result
        FROM
            hotplace hp
        JOIN
            hotplace_cate hc ON hp.hotplace_cate_no = hc.hotplace_cate_no
        LEFT JOIN
            mymap mm ON hp.hotplace_no = mm.hotplace_no
        LEFT JOIN
            emoreview er ON mm.map_no = er.map_no AND mm.hotplace_no = er.hotplace_no
        GROUP BY
            hp.sido, hp.gugun, hp.hotplace_name, hc.hotplace_cate_name
      ]]>
    </select>

    <select id="newPlaceCnt" resultType="int">
        <![CDATA[
        select COUNT(hp.hotplace_no)
        from hotplace hp
        where exists ( select 1 from mymap mm where mm.hotplace_no = hp.hotplace_no and timestampdiff(month, mm.recom_date,now()) <1)
      ]]>
    </select>

    <select id="hotplaceTotal" resultType="int">
        <![CDATA[
        select COUNT(hotplace_no)
        from hotplace
      ]]>
    </select>

    <select id="emoAvg" resultType="double">
        <![CDATA[
        select round(avg(emo_result),2)
        from emoreview
      ]]>
    </select>

    <select id="RecentEmoAvg" resultType="double">
        <![CDATA[
        select round(avg(er.emo_result),2)
        from emoreview er
        where exists (select 1 from mymap mm where mm.map_no = er.map_no and timestampdiff(month, mm.recom_date,now()) <1)
      ]]>
    </select>

    <select id="monthlyActiveUser" resultType="int" parameterType="int">
        <![CDATA[
        SELECT COUNT(DISTINCT user_no)
        FROM ddogo.mymap
        WHERE recom_date >= DATE_FORMAT(CURDATE() - INTERVAL #{monthlyGab} MONTH ,'%Y-%m-01')
        AND (recom_date < DATE_FORMAT(CURDATE() - INTERVAL (#{monthlyGab} - 1) MONTH ,'%Y-%m-01') OR #{monthlyGab} = 0)
      ]]>
    </select>

    <select id="yearlyActiveUser" resultType="int" parameterType="int">
        <![CDATA[
        SELECT COUNT(DISTINCT user_no)
        FROM ddogo.mymap
        WHERE recom_date >= DATE_FORMAT(CURDATE() - INTERVAL #{yearlyGab} YEAR, '%Y-01-01')
        AND recom_date < DATE_FORMAT(CURDATE() - INTERVAL (#{yearlyGab} - 1) YEAR, '%Y-01-01')

      ]]>
    </select>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="statistics">

    <!-- 이용자통계 -->
    <!-- 유저수 조회 -->
    <select id="userCnt" resultType="int" parameterType="map">
        <![CDATA[
            select count(user_no)
            from ddogo.user
            where 1=1
		]]>
        <if test="map!=null">
            <if test="year!=null">
                <![CDATA[
                    and year(joinDate)=#{year}
                ]]>
            </if>
            <if test="month!=null">
                <![CDATA[
                    and month(joinDate)=#{month}
                ]]>
            </if>
            <if test="gender!=null">
                and gender=#{gender} and timestampdiff(month,birth,now()) between #{fAge} and #{cAge}
            </if>
        </if>
    </select>

    <!-- 액티브 유저 수 -->
    <select id="activeUserCnt" resultType="int" parameterType="map">
        <![CDATA[
            select count(distinct user_no)
            from ddogo.mymap m, ddogo.user u
            where 1=1
		]]>
        <if test="map!=null">
            <if test="year!=null">
                <![CDATA[
                    and year(m.recom_date)=#{year}
                ]]>
            </if>
            <if test="month!=null">
                <![CDATA[
                    and month(m.recom_date)=#{month}
                ]]>
            </if>
            <if test="gender!=null">
                where u.gender=#{gender} and timestampdiff(month,u.birth,now()) between #{fAge} and #{cAge}
            </if>
        </if>
    </select>

    <!-- 맛집 통계 -->
    <!-- 맛집 월별 지역별 카테고리별 나이-성별별 랭킹 -->
    <select id="hotplaceRank" resultType="com.yumpro.ddogo.admin.domain.HotplaceDTO" parameterType="map">
        <![CDATA[
            select h.hotplace_no,h.sido,h.gugun,h.hotplace_name,h.address,h.hotplace_cate_no
            from ddogo.hotplace h, ddogo.mymap m, ddogo.user u
            where m.recom_date between #{startDate} and #{lastDate}
		]]>
        <if test="sido!=null">
            and h.sido=#{sido}
        </if>
        <if test="sido!=null">
            and h.gugun=#{gugun}
        </if>
        <if test="gender!=null">
            and u.gender=#{gender} and timestampdiff(month,u.birth,now()) between #{fAge} and #{cAge}
        </if>
        <if test="cate!=null and cate!=''">
            and h.hatplace_cate_no=#{cate}
        </if>
        order by (select count(map_no) from ddogo.mymap where recom='y') desc limit 10
    </select>

    <!-- (카테고리별) 지역별 맛집 개수 -->
    <select id="hotplaceCnt" resultType="int" parameterType="map">
        <![CDATA[
            select count(h.hatplace_name)
            where 1=1
		]]>
        <if test="sido!=null">
            and h.sido=#{sido}
        </if>
        <if test="gugun!=null">
            and h.gugun=#{gugun}
        </if>
        <if test="cate!=null">
            and h.hatplace_cate_no=#{cate}
        </if>
    </select>

    <!-- 감정통계 -->
    <!-- 감정 평균 -->
    <select id="imoAvg" resultType="double" parameterType="map">
        <![CDATA[
            select avg(e.emo_result)
            from ddogo.emoreview e, ddogo.mymap m, ddogo.user u, ddogo.hatplace
            where timestampdiff(month,m.recom_date,now()) <=1
		]]>
        <if test="map!=null">
            <if test="year!=null">
                <![CDATA[
                    and year(m.recom_date)=#{year}
                ]]>
            </if>
            <if test="month!=null">
                <![CDATA[
                    and month(m.recom_date)=#{month}
                ]]>
            </if>
            <if test="gender!=null">
                and u.gender=#{gender} and timestampdiff(month,u.birth,now()) between #{fAge} and #{cAge}
            </if>
            <if test="sido!=null">
                and h.sido=#{sido}
            </if>
        </if>
    </select>
</mapper>
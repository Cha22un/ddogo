<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="statistics">

    <!-- 이용자통계 -->
    <!-- (나이-성별 별) 총 회원수 조회 -->
    <select id="totalUser" resultType="int" parameterType="map">
        <![CDATA[
            select count(user_no)
            from ddogo.user
		]]>
        <if test="map!=null">
            <if test="gender!=null and gender!=''">
                where gender=#{gender} and timestampdiff(month,birth,now()) between #{fAge} and #{cAge}
            </if>
        </if>
    </select>

    <!-- (나이-성별 별) 최근 한달 가입 회원수 조회 -->
    <select id="recentUser" resultType="int" parameterType="map">
        <![CDATA[
            select count(user_no)
            from ddogo.user
            where timestampdiff(month,joinDate,now()) <=1;
		]]>
        <if test="map!=null">
            <if test="gender!=null and gender!=''">
                where gender=#{gender} and timestampdiff(month,birth,now()) between #{fAge} and #{cAge}
            </if>
        </if>
    </select>

    <!-- 이용자 활동 통계 -->
    <!-- 한달 액티브 유저 수 -->
    <select id="activeUser" resultType="int" parameterType="map">
        <![CDATA[
            select count(distinct user_no)
            from ddogo.mymap
            where timestampdiff(month,recom_date,now()) <=1
		]]>
        <if test="map!=null">
            <if test="gender!=null and gender!=''">
                where gender=#{gender} and timestampdiff(month,birth,now()) between #{fAge} and #{cAge}
            </if>
        </if>
    </select>

    <!-- 맛집 통계 -->
    <!-- 맛집 월별 지역별 (카테고리별 나이-성별별) 랭킹 -->
    <select id="ranking" resultType="int" parameterType="map">
        <![CDATA[
            select h.hatplace_name
            from ddogo.hotplace h, ddogo.mymap m, ddogo.user u
            where m.recom_date between #{startDate} and #{lastDate} and h.sido=#{sido} and h.gugun=#{gugun}
		]]>
        <if test="gender!=null and gender!=''">
            and u.gender=#{gender} and timestampdiff(month,u.birth,now()) between #{fAge} and #{cAge}
        </if>
        <if test="cate!=null and cate!=''">
            and h.hatplace_cate_no=#{cate}
        </if>
        order by (select count(map_no) from ddogo.mymap where recom='y') desc limit 10
    </select>

    <!-- (카테고리별) 지역별 맛집 개수 -->
    <select id="hotplaceCntByloc" resultType="int" parameterType="map">
        <![CDATA[
            select count(h.hatplace_name)
            where 1=1
		]]>
        <if test="cate!=null and cate!=''">
            and h.sido=#{sido} and h.gugun=#{gugun}
        </if>
        <if test="cate!=null and cate!=''">
            and h.hatplace_cate_no=#{cate}
        </if>
    </select>

    <!-- -->
    <!-- -->
    <!-- -->
    <!-- -->
    <!-- -->
    <!-- -->
    <!-- -->
    <!-- -->

</mapper>